<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script>
const display_width = 1280;
const display_height = 720;
const button_width = 80;
const button_height = 83;
const button_dx = -46;

var canvas_dom = null;
var canvas_context = null;

function load_image(path, onload) {
  var img = new Image();
  if (onload) 
    img.addEventListener('load', onload.bind(img), false);
  img.src = path;
  return img;
}

var Button = function(name, x, y) {
  return {
    'img': null,
    'name': name,
    'x': x,
    'y': y,
    'enabled': false,
    'load': function(context) {
      var path = "img/" + this.name + ".png";
      this.img = load_image(path, function() {
        canvas_context.drawImage(this, 0, 0, display_width, display_height);
      });
    }
  };
}

var legends = [
  new Button('bloodhound', 783, 187),
  new Button('gibraltar', 863, 187),
  new Button('lifeline', 943, 187),
  new Button('pathfinder', 1023, 187),
  new Button('wraith', 1103, 187),
  new Button('bangalore', 756, 271),
  new Button('caustic', 836, 271),
  new Button('mirage', 916, 271),
  new Button('octane', 996, 271),
  new Button('wattson', 1076, 271),
  new Button('crypto', 729, 355),
  new Button('revenant', 809, 355),
  new Button('loba', 889, 355),
  new Button('rampart', 969, 355),
  new Button('horizon', 1049, 355),
  new Button('fuse', 703, 439),
  new Button('valkyrie', 783, 439),
  new Button('seer', 863, 439),
  new Button('ash', 943, 439),
  new Button('mad-maggie', 1023, 439),
];

var spin = new Button('spin', 1103, 439);

const DORMANT_STATE = 1;
const READY_STATE = 2;
const SPINNING_STATE = 3;
var current_state = 0;

function draw_blank(context, x, y) {
  context.beginPath();
  context.moveTo(x, y);
  context.lineTo(x+button_width, y);
  context.lineTo(x+button_width+button_dx, y+button_height);
  context.lineTo(x+button_dx, y+button_height);
  context.lineTo(x, y);
  context.closePath();
  context.fillStyle = "#ff00ff";
  context.fill();
}

// Call this when going into the dormant state.
function all_blank(context) {
  var coords = [];
  for (const [name, value] of Object.entries(legends)) {
    if (value.x && value.y) {
      coords.push([value.x, value.y]);
    }
  }
  coords.push([spin.x, spin.y]);

  var decay = function() {
    if (coords.length == 0) return;
    draw_blank(context, coords[0][0], coords[0][1]);
    coords.shift();
    setTimeout(decay, 25);
  }
  decay();
}

function test_inside(obj, x, y) {
  // TODO determine whether (x, y) is within the rhombus anchored to obj.
}

function handle_click(e) {
  // TODO check current state, handle state transitions
  console.log("click event at (" + e.clientX + "," + e.clientY + ")");
}

function ready_state() {
  // TODO display "????" spin button,
  // begin animation of displaying legends in greyscale
}

function spinning_state() {
  // 
}

var start = function() {
  canvas_dom = document.getElementById('overlay');
  if (!canvas_dom.getContext) {
    alert('There is something wrong with the <canvas> element.');
    return;
  }
  canvas_dom.width = display_width;
  canvas_dom.height = display_height;
  canvas_dom.addEventListener('click', handle_click, false);

  canvas_context = canvas_dom.getContext('2d');
  if (!background.img) {
    background.img = document.getElementById("background");
    canvas_context.drawImage(background.img, 0, 0, display_width, display_height);
  }
  for (const [name, value] of Object.entries(legends)) {
    if (!value.img) legends[name].img = legends[name].load();
  }
  if (!spin.img) spin.load();

  setTimeout(() => { all_blank(canvas_context); }, 444);

};
    </script>
  </head>

  <body onload="start();" style="border:0;margin:0;">
    <canvas id="overlay" style="border:0;padding:0;">
      Hmm... something is keeping your browser from including the CANVAS element in the DOM.
    </canvas>
    <div style="display:none">  <!-- prefetch some images -->
      <img id="background" src="img/all-legends-greyscale.png">
    </div>
  </body>
</html>